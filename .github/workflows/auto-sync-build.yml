name: Sync and Auto Build Release

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥æ›´æ–°
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DOTNET_SDK_VERSION: '9.0.*'
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true

jobs:
  sync-and-check:
    runs-on: ubuntu-latest
    outputs:
      has-new-commits: ${{ steps.sync.outputs.has_new_commits }}
      new-version: ${{ steps.version.outputs.version }}
      build-date: ${{ steps.get_date.outputs.date }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/nilaoda/BBDown.git || true
          git fetch upstream

      - name: Check for updates
        id: sync
        run: |
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse upstream/master)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
            echo "å‘çŽ°æ–°çš„æäº¤ï¼Œå‡†å¤‡åŒæ­¥..."
            
            git merge upstream/master --no-edit
            git push origin master
            
            echo "åŒæ­¥å®Œæˆï¼"
          else
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ–°çš„æ›´æ”¹"
          fi

      - name: Get Date in UTC+8
        id: get_date
        run: echo "date=$(date -u -d '8 hours' +'%Y%m%d')" >> "$GITHUB_OUTPUT"

      - name: Generate version tag
        id: version
        if: steps.sync.outputs.has_new_commits == 'true'
        run: |
          VERSION="auto-${{ steps.get_date.outputs.date }}-$(date +'%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

  build-win-x64-arm64:
    needs: sync-and-check
    if: needs.sync-and-check.outputs.has-new-commits == 'true'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

      - name: Install zip
        run: choco install zip --no-progress --yes

      - name: Publish [win]
        run: |
          dotnet publish BBDown -r win-x64 -c Release -o artifact
          dotnet publish BBDown -r win-arm64 -c Release -o artifact-arm64

      - name: Package [win]
        run: |
          cd artifact
          zip ../BBDown_${{ needs.sync-and-check.outputs.build-date }}_win-x64.zip BBDown.exe
          cd ../artifact-arm64
          zip ../BBDown_${{ needs.sync-and-check.outputs.build-date }}_win-arm64.zip BBDown.exe

      - name: Upload Artifact [win-x64]
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_win-x64
          path: BBDown_${{ needs.sync-and-check.outputs.build-date }}_win-x64.zip

      - name: Upload Artifact [win-arm64]
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_win-arm64
          path: BBDown_${{ needs.sync-and-check.outputs.build-date }}_win-arm64.zip

  build-linux-x64-arm64:
    needs: sync-and-check
    if: needs.sync-and-check.outputs.has-new-commits == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: setup deb822 repos
        run: |
          if [[ $ImageOS == "ubuntu24" ]]; then
            cat <<EOF > deb822sources
          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu/
          Suites: noble
          Components: main restricted universe
          Architectures: amd64

          Types: deb
          URIs: http://security.ubuntu.com/ubuntu/
          Suites: noble-security
          Components: main restricted universe
          Architectures: amd64

          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu/
          Suites: noble-updates
          Components: main restricted universe
          Architectures: amd64

          Types: deb
          URIs: http://azure.ports.ubuntu.com/ubuntu-ports/
          Suites: noble
          Components: main restricted multiverse universe
          Architectures: arm64

          Types: deb
          URIs: http://azure.ports.ubuntu.com/ubuntu-ports/
          Suites: noble-updates
          Components: main restricted multiverse universe
          Architectures: arm64
          EOF

            sudo mv deb822sources /etc/apt/sources.list.d/ubuntu.sources
          fi

      - name: Setup cross-compilation for ARM64
        run: |
          sudo dpkg --add-architecture arm64
          sudo bash -c 'cat > /etc/apt/sources.list.d/arm64.list <<EOF
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy main restricted
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates main restricted
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-backports main restricted universe multiverse
          EOF'
          sudo sed -i -e 's/deb http/deb [arch=amd64] http/g' /etc/apt/sources.list
          sudo sed -i -e 's/deb mirror/deb [arch=amd64] mirror/g' /etc/apt/sources.list
          sudo apt-get update
          sudo apt-get install -y curl wget libicu-dev libcurl4-openssl-dev zlib1g-dev libkrb5-dev clang llvm binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu zlib1g-dev:arm64

      - uses: actions/checkout@v4

      - name: Set up dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

      - name: Publish [linux]
        run: |
          dotnet publish BBDown -r linux-x64 -c Release -o artifact
          dotnet publish BBDown -r linux-arm64 -c Release -o artifact-arm64

      - name: Package [linux]
        run: |
          cd artifact
          zip ../BBDown_${{ needs.sync-and-check.outputs.build-date }}_linux-x64.zip BBDown
          cd ../artifact-arm64
          zip ../BBDown_${{ needs.sync-and-check.outputs.build-date }}_linux-arm64.zip BBDown

      - name: Upload Artifact [linux-x64]
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_linux-x64
          path: BBDown_${{ needs.sync-and-check.outputs.build-date }}_linux-x64.zip

      - name: Upload Artifact[linux-arm64]
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_linux-arm64
          path: BBDown_${{ needs.sync-and-check.outputs.build-date }}_linux-arm64.zip

  build-mac-x64-arm64:
    needs: sync-and-check
    if: needs.sync-and-check.outputs.has-new-commits == 'true'
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

      - name: Publish [osx]
        run: |
          dotnet publish BBDown -r osx-x64 -c Release -o artifact
          dotnet publish BBDown -r osx-arm64 -c Release -o artifact-arm64

      - name: Package [osx]
        run: |
          cd artifact
          zip ../BBDown_${{ needs.sync-and-check.outputs.build-date }}_osx-x64.zip BBDown
          cd ../artifact-arm64
          zip ../BBDown_${{ needs.sync-and-check.outputs.build-date }}_osx-arm64.zip BBDown

      - name: Upload Artifact [osx-x64]
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_osx-x64
          path: BBDown_${{ needs.sync-and-check.outputs.build-date }}_osx-x64.zip

      - name: Upload Artifact [osx-arm64]
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_osx-arm64
          path: BBDown_${{ needs.sync-and-check.outputs.build-date }}_osx-arm64.zip

  create-release:
    needs: [sync-and-check, build-win-x64-arm64, build-linux-x64-arm64, build-mac-x64-arm64]
    if: needs.sync-and-check.outputs.has-new-commits == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Organize release files
        run: |
          mkdir -p ./release-files
          find ./artifacts -name "*.zip" | xargs -I {} cp {} ./release-files/
          ls -la ./release-files

      - name: Get latest commit info
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.sync-and-check.outputs.new-version }}
          name: "Auto Release ${{ needs.sync-and-check.outputs.new-version }}"
          body: |
            ðŸ¤– **è‡ªåŠ¨æž„å»ºå‘å¸ƒ**
            
            è¿™æ˜¯åŸºäºŽä¸Šæ¸¸ä»“åº“æœ€æ–°ä»£ç çš„è‡ªåŠ¨æž„å»ºç‰ˆæœ¬ã€‚
            
            **æ›´æ–°å†…å®¹:**
            - æœ€æ–°æäº¤: ${{ steps.commit.outputs.message }}
            - æäº¤å“ˆå¸Œ: ${{ steps.commit.outputs.hash }}
            - æž„å»ºæ—¶é—´: ${{ github.run_started_at }}
            
            **æ”¯æŒå¹³å°:**
            - âœ… Windows x64/ARM64
            - âœ… Linux x64/ARM64  
            - âœ… macOS x64/ARM64
            
            **ä½¿ç”¨è¯´æ˜Ž:**
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
            2. è§£åŽ‹åŽå³å¯ç›´æŽ¥è¿è¡Œ
            3. è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒ [åŽŸé¡¹ç›®æ–‡æ¡£](https://github.com/nilaoda/BBDown)
            
            ---
            > æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æž„å»ºï¼ŒåŸºäºŽ [nilaoda/BBDown](https://github.com/nilaoda/BBDown) æœ€æ–°ä»£ç 
          files: ./release-files/*
          draft: false
          prerelease: false
          generate_release_notes: false

  # å¤±è´¥æ—¶çš„ç®€å•æ—¥å¿—è®°å½•
  log-failure:
    needs: [sync-and-check, build-win-x64-arm64, build-linux-x64-arm64, build-mac-x64-arm64, create-release]
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Log build failure
        run: |
          echo "ðŸš¨ è‡ªåŠ¨æž„å»ºå¤±è´¥ - $(date '+%Y-%m-%d %H:%M:%S')"
          echo "å·¥ä½œæµè¿è¡Œ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          echo "å¸¸è§åŽŸå› ï¼š"
          echo "- ä¸Šæ¸¸ä»£ç å˜æ›´å¯¼è‡´ç¼–è¯‘é”™è¯¯"
          echo "- ä¾èµ–é¡¹ç‰ˆæœ¬å†²çª"
          echo "- .NET SDKç‰ˆæœ¬ä¸å…¼å®¹"
          echo "- ç½‘ç»œè¿žæŽ¥é—®é¢˜"
          echo ""
          echo "è¯·æŸ¥çœ‹ä¸Šé¢çš„æž„å»ºæ—¥å¿—è¿›è¡ŒæŽ’æŸ¥"
          
          # åœ¨GitHub Actionsç•Œé¢æ˜¾ç¤ºå¤±è´¥æ‘˜è¦
          echo "## ðŸš¨ è‡ªåŠ¨æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¤±è´¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¸¸è§åŽŸå› " >> $GITHUB_STEP_SUMMARY
          echo "- ä¸Šæ¸¸ä»£ç å˜æ›´å¯¼è‡´ç¼–è¯‘é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "- ä¾èµ–é¡¹ç‰ˆæœ¬å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "- .NET SDKç‰ˆæœ¬ä¸å…¼å®¹" >> $GITHUB_STEP_SUMMARY
          echo "- ç½‘ç»œè¿žæŽ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY

  # æˆåŠŸæ—¶çš„ç®€å•é€šçŸ¥
  success-summary:
    needs: [sync-and-check, create-release]
    if: success() && needs.sync-and-check.outputs.has-new-commits == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Display success summary
        run: |
          echo "ðŸŽ‰ BBDownè‡ªåŠ¨æž„å»ºæˆåŠŸå®Œæˆï¼"
          echo ""
          echo "ðŸ“¦ å‘å¸ƒç‰ˆæœ¬: ${{ needs.sync-and-check.outputs.new-version }}"
          echo "ðŸ”— Releaseåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ needs.sync-and-check.outputs.new-version }}"
          echo "â° æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "æ”¯æŒå¹³å°ï¼š"
          echo "  âœ… Windows (x64/ARM64)"
          echo "  âœ… Linux (x64/ARM64)"
          echo "  âœ… macOS (x64/ARM64)"
          
          # åœ¨GitHub Actionsç•Œé¢è®¾ç½®è¾“å‡ºæ‘˜è¦
          echo "## ðŸŽ‰ BBDownè‡ªåŠ¨æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${{ needs.sync-and-check.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**å‘å¸ƒåœ°å€**: [ç‚¹å‡»æŸ¥çœ‹Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.sync-and-check.outputs.new-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ”¯æŒå¹³å°" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows (x64/ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux (x64/ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS (x64/ARM64)" >> $GITHUB_STEP_SUMMARY
